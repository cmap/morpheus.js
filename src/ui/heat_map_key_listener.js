morpheus.KeyboardCharMap = [
	'', // [0]
	'', // [1]
	'', // [2]
	'CANCEL', // [3]
	'', // [4]
	'', // [5]
	'HELP', // [6]
	'', // [7]
	'BACKSPACE', // [8]
	'TAB', // [9]
	'', // [10]
	'', // [11]
	'CLEAR', // [12]
	'ENTER', // [13]
	'ENTER_SPECIAL', // [14]
	'', // [15]
	'SHIFT', // [16]
	'CONTROL', // [17]
	'ALT', // [18]
	'PAUSE', // [19]
	'CAPS_LOCK', // [20]
	'KANA', // [21]
	'EISU', // [22]
	'JUNJA', // [23]
	'FINAL', // [24]
	'HANJA', // [25]
	'', // [26]
	'Escape', // [27]
	'CONVERT', // [28]
	'NONCONVERT', // [29]
	'ACCEPT', // [30]
	'MODECHANGE', // [31]
	'Space', // [32]
	'Page Up', // [33]
	'Page Down', // [34]
	'End', // [35]
	'Home', // [36]
	'Left', // [37]
	'Up', // [38]
	'Right', // [39]
	'Down', // [40]
	'SELECT', // [41]
	'PRINT', // [42]
	'EXECUTE', // [43]
	'PRINTSCREEN', // [44]
	'INSERT', // [45]
	'Delete', // [46]
	'', // [47]
	'0', // [48]
	'1', // [49]
	'2', // [50]
	'3', // [51]
	'4', // [52]
	'5', // [53]
	'6', // [54]
	'7', // [55]
	'8', // [56]
	'9', // [57]
	'COLON', // [58]
	'SEMICOLON', // [59]
	'LESS_THAN', // [60]
	'Equals', // [61]
	'GREATER_THAN', // [62]
	'QUESTION_MARK', // [63]
	'AT', // [64]
	'A', // [65]
	'B', // [66]
	'C', // [67]
	'D', // [68]
	'E', // [69]
	'F', // [70]
	'G', // [71]
	'H', // [72]
	'I', // [73]
	'J', // [74]
	'K', // [75]
	'L', // [76]
	'M', // [77]
	'N', // [78]
	'O', // [79]
	'P', // [80]
	'Q', // [81]
	'R', // [82]
	'S', // [83]
	'T', // [84]
	'U', // [85]
	'V', // [86]
	'W', // [87]
	'X', // [88]
	'Y', // [89]
	'Z', // [90]
	'OS_KEY', // [91] Windows Key (Windows) or Command Key (Mac)
	'', // [92]
	'CONTEXT_MENU', // [93]
	'', // [94]
	'SLEEP', // [95]
	'0', // [96]
	'1', // [97]
	'2', // [98]
	'3', // [99]
	'4', // [100]
	'5', // [101]
	'6', // [102]
	'7', // [103]
	'8', // [104]
	'9', // [105]
	'MULTIPLY', // [106]
	'+', // [107]
	'SEPARATOR', // [108]
	'SUBTRACT', // [109]
	'DECIMAL', // [110]
	'DIVIDE', // [111]
	'F1', // [112]
	'F2', // [113]
	'F3', // [114]
	'F4', // [115]
	'F5', // [116]
	'F6', // [117]
	'F7', // [118]
	'F8', // [119]
	'F9', // [120]
	'F10', // [121]
	'F11', // [122]
	'F12', // [123]
	'F13', // [124]
	'F14', // [125]
	'F15', // [126]
	'F16', // [127]
	'F17', // [128]
	'F18', // [129]
	'F19', // [130]
	'F20', // [131]
	'F21', // [132]
	'F22', // [133]
	'F23', // [134]
	'F24', // [135]
	'', // [136]
	'', // [137]
	'', // [138]
	'', // [139]
	'', // [140]
	'', // [141]
	'', // [142]
	'', // [143]
	'NUM_LOCK', // [144]
	'SCROLL_LOCK', // [145]
	'WIN_OEM_FJ_JISHO', // [146]
	'WIN_OEM_FJ_MASSHOU', // [147]
	'WIN_OEM_FJ_TOUROKU', // [148]
	'WIN_OEM_FJ_LOYA', // [149]
	'WIN_OEM_FJ_ROYA', // [150]
	'', // [151]
	'', // [152]
	'', // [153]
	'', // [154]
	'', // [155]
	'', // [156]
	'', // [157]
	'', // [158]
	'', // [159]
	'CIRCUMFLEX', // [160]
	'EXCLAMATION', // [161]
	'DOUBLE_QUOTE', // [162]
	'HASH', // [163]
	'DOLLAR', // [164]
	'PERCENT', // [165]
	'AMPERSAND', // [166]
	'UNDERSCORE', // [167]
	'OPEN_PAREN', // [168]
	'CLOSE_PAREN', // [169]
	'ASTERISK', // [170]
	'Plus', // [171]
	'PIPE', // [172]
	'-', // [173]
	'OPEN_CURLY_BRACKET', // [174]
	'CLOSE_CURLY_BRACKET', // [175]
	'TILDE', // [176]
	'', // [177]
	'', // [178]
	'', // [179]
	'', // [180]
	'VOLUME_MUTE', // [181]
	'VOLUME_DOWN', // [182]
	'VOLUME_UP', // [183]
	'', // [184]
	'', // [185]
	'SEMICOLON', // [186]
	'EQUALS', // [187]
	'COMMA', // [188]
	'MINUS', // [189]
	'PERIOD', // [190]
	'/', // [191]
	'BACK_QUOTE', // [192]
	'', // [193]
	'', // [194]
	'', // [195]
	'', // [196]
	'', // [197]
	'', // [198]
	'', // [199]
	'', // [200]
	'', // [201]
	'', // [202]
	'', // [203]
	'', // [204]
	'', // [205]
	'', // [206]
	'', // [207]
	'', // [208]
	'', // [209]
	'', // [210]
	'', // [211]
	'', // [212]
	'', // [213]
	'', // [214]
	'', // [215]
	'', // [216]
	'', // [217]
	'', // [218]
	'OPEN_BRACKET', // [219]
	'BACK_SLASH', // [220]
	'CLOSE_BRACKET', // [221]
	'QUOTE', // [222]
	'', // [223]
	'META', // [224]
	'ALTGR', // [225]
	'', // [226]
	'WIN_ICO_HELP', // [227]
	'WIN_ICO_00', // [228]
	'', // [229]
	'WIN_ICO_CLEAR', // [230]
	'', // [231]
	'', // [232]
	'WIN_OEM_RESET', // [233]
	'WIN_OEM_JUMP', // [234]
	'WIN_OEM_PA1', // [235]
	'WIN_OEM_PA2', // [236]
	'WIN_OEM_PA3', // [237]
	'WIN_OEM_WSCTRL', // [238]
	'WIN_OEM_CUSEL', // [239]
	'WIN_OEM_ATTN', // [240]
	'WIN_OEM_FINISH', // [241]
	'WIN_OEM_COPY', // [242]
	'WIN_OEM_AUTO', // [243]
	'WIN_OEM_ENLW', // [244]
	'WIN_OEM_BACKTAB', // [245]
	'ATTN', // [246]
	'CRSEL', // [247]
	'EXSEL', // [248]
	'EREOF', // [249]
	'PLAY', // [250]
	'ZOOM', // [251]
	'', // [252]
	'PA1', // [253]
	'WIN_OEM_CLEAR', // [254]
	'' // [255]
];
morpheus.HeatMapKeyListener = function (controller) {
	/**
	 * Shortcut object contains
	 * @param options.which Array of key codes
	 * @param options.shift Whether shift key is required
	 * @param options.commandKey Whether command key is required
	 * @param options.name Shortcut name
	 * @param options.cb Function callback
	 * @param options.accept Additional function to test whether to accept shortcut
	 */
	var shortcutsWhenNotInInputField = [];
	var shortcuts = [];
	shortcutsWhenNotInInputField.push({
		which: [107, 61, 187],
		name: 'Zoom In',
		cb: function () {
			controller.zoom(true);
		}
	});
	shortcutsWhenNotInInputField.push({
		which: [173, 189, 109],
		name: 'Zoom Out',
		cb: function () {
			controller.zoom(false);
		}
	});
	shortcutsWhenNotInInputField.push({
		which: [35],
		name: 'Go To End',
		cb: function () {
			controller.scrollLeft(controller.heatmap.getPreferredSize().width);
			controller.scrollTop(controller.heatmap.getPreferredSize().height);
		}
	});
	shortcutsWhenNotInInputField.push({
		which: [36], // home key
		name: 'Go To Start',
		cb: function () {
			controller.scrollLeft(0);
			controller.scrollTop(0);
		}
	});
	shortcutsWhenNotInInputField.push({
		which: [34], // page down
		commandKey: true,
		name: 'Go To Bottom',
		cb: function () {
			controller
			.scrollTop(controller.heatmap.getPreferredSize().height);
		}
	});
	shortcutsWhenNotInInputField.push({
		which: [34], // page down
		commandKey: false,
		name: 'Scroll Page Down',
		cb: function () {
			var pos = controller.scrollTop();
			controller.scrollTop(pos + controller.heatmap.getUnscaledHeight()
				- 2);
		}
	});

	shortcutsWhenNotInInputField.push({
		which: [33], // page up
		commandKey: true,
		name: 'Go To Top',
		cb: function () {
			controller
			.scrollTop(0);
		}
	});
	shortcutsWhenNotInInputField.push({
		which: [33], // page up
		commandKey: false,
		name: 'Scroll Page Up',
		cb: function () {
			var pos = controller.scrollTop();
			controller.scrollTop(pos - controller.heatmap.getUnscaledHeight()
				+ 2);
		}
	});

	shortcutsWhenNotInInputField.push({
		which: [38], // up arrow
		commandKey: true,
		name: 'Zoom Out Rows',
		cb: function () {
			controller.zoom(false, {
				columns: false,
				rows: true
			});
		}
	});
	shortcutsWhenNotInInputField.push({
		which: [38], // up arrow
		commandKey: false,
		name: 'Scroll Up',
		cb: function () {
			controller.scrollTop(controller.scrollTop() - 8);
		}
	});

	shortcutsWhenNotInInputField.push({
		which: [40], // down arrow
		commandKey: true,
		name: 'Zoom In Rows',
		cb: function () {
			controller.zoom(true, {
				columns: false,
				rows: true
			});
		}
	});
	shortcutsWhenNotInInputField.push({
		which: [40], // down arrow
		commandKey: false,
		name: 'Scroll Down',
		cb: function () {
			controller.scrollTop(controller.scrollTop() + 8);
		}
	});

	shortcutsWhenNotInInputField.push({
		which: [37], // left arrow
		commandKey: true,
		name: 'Zoom Out Columns',
		cb: function () {
			controller.zoom(false, {
				columns: true,
				rows: false
			});
		}
	});
	shortcutsWhenNotInInputField.push({
		which: [37], // left arrow
		commandKey: false,
		name: 'Scroll Left',
		cb: function () {
			controller.scrollLeft(controller.scrollLeft() - 8);
		}
	});

	shortcutsWhenNotInInputField.push({
		which: [39], // right arrow
		commandKey: true,
		name: 'Zoom In Columns',
		cb: function () {
			controller.zoom(true, {
				columns: true,
				rows: false
			});
		}
	});
	shortcutsWhenNotInInputField.push({
		which: [39], // right arrow
		commandKey: false,
		name: 'Scroll Right',
		cb: function () {
			controller.scrollLeft(controller.scrollLeft() + 8);
		}
	});
	shortcutsWhenNotInInputField.push({
		which: [65], // a
		commandKey: true,
		name: 'Select All',
		accept: function () {
			var active = controller.getActiveComponent();
			return (active === 'rowTrack' || active === 'columnTrack');
		},
		cb: function () {
			var active = controller.getActiveComponent();

			var selectionModel = active === 'rowTrack' ? controller.getProject()
				.getRowSelectionModel() : controller.getProject()
				.getColumnSelectionModel();
			var count = active === 'rowTrack' ? controller.getProject()
				.getSortedFilteredDataset().getRowCount() : controller
				.getProject().getSortedFilteredDataset()
				.getColumnCount();
			var indices = new morpheus.Set();
			for (var i = 0; i < count; i++) {
				indices.add(i);
			}
			selectionModel.setViewIndices(indices, true);

		}
	});

	shortcuts.push({
		which: [83],
		shiftKey: true,
		commandKey: true,
		name: 'Save Dataset',
		cb: function () {
			morpheus.HeatMap.showTool(new morpheus.SaveDatasetTool(),
				controller);
		}
	});
	shortcuts.push({
		which: [83],
		shiftKey: false,
		commandKey: true,
		name: 'Save Image',
		cb: function () {
			morpheus.HeatMap.showTool(new morpheus.SaveImageTool(),
				controller);
		}
	});
	shortcuts.push({
		which: [79],
		commandKey: true,
		name: 'Open File',
		cb: function () {
			morpheus.HeatMap.showTool(new morpheus.OpenFileTool(),
				controller);
		}
	});
	shortcuts.push({
		which: [191], // slash
		commandKey: true,
		name: 'Toggle Search',
		cb: function () {
			controller.getToolbar().toggleSearch();
		}
	});
	shortcuts.push({
		which: [88], // x
		commandKey: true,
		name: 'New Heat Map',
		accept: function (options) {
			return (!options.isInputField || window.getSelection().toString() === '');
		},
		cb: function () {
			morpheus.HeatMap.showTool(new morpheus.NewHeatMapTool(),
				controller);
		}
	});
	shortcuts.push({
		which: [67], // C
		commandKey: true,
		name: 'Copy'
	});
	shortcuts.push({
		which: [86], // V
		commandKey: true,
		name: 'Paste Dataset'
	});

	var keydown = function (e) {
		var tagName = e.target.tagName;
		var found = false;
		var commandKey = morpheus.Util.IS_MAC ? e.metaKey : e.ctrlKey;
		var altKey = e.altKey;
		var shiftKey = e.shiftKey;
		var which = e.which;
		var isInputField = (tagName == 'INPUT' || tagName == 'SELECT' || tagName == 'TEXTAREA');
		var acceptOptions = {isInputField: isInputField};
		var shortcutMatches = function (sc) {
			if (sc.cb !== undefined && sc.which.indexOf(which) !== -1 && (sc.commandKey === undefined || commandKey === sc.commandKey) && (sc.shiftKey === undefined || shiftKey === sc.shiftKey) && (sc.accept == undefined || sc.accept(acceptOptions))) {
				sc.cb();
				return true;
			}
		};
		if (!isInputField) {
			for (var i = 0, n = shortcutsWhenNotInInputField.length; i < n; i++) {
				var sc = shortcutsWhenNotInInputField[i];
				if (shortcutMatches(sc)) {
					found = true;
					break;
				}
			}
		}
		if (!found) {
			for (var i = 0, n = shortcuts.length; i < n; i++) {
				var sc = shortcuts[i];
				if (shortcutMatches(sc)) {
					found = true;
					break;
				}
			}
		}
		if (found) {
			e.preventDefault();
			e.stopPropagation();
			e.stopImmediatePropagation();
			return false;
		}
	};
	var $keyelement = controller.$tabPanel;
	$keyelement.on('keydown', keydown);
	$keyelement.on('dragover.morpheus dragenter.morpheus', function (e) {
		e.preventDefault();
		e.stopPropagation();
	}).on(
		'drop.morpheus',
		function (e) {
			if (e.originalEvent.dataTransfer
				&& e.originalEvent.dataTransfer.files.length) {
				e.preventDefault();
				e.stopPropagation();
				var files = e.originalEvent.dataTransfer.files;
				morpheus.HeatMap.showTool(new morpheus.OpenFileTool({
					file: files[0]
				}), controller);
			}
		});
	$keyelement.on('paste.morpheus',
		function (e) {
			var tagName = e.target.tagName;
			if (tagName == 'INPUT' || tagName == 'SELECT'
				|| tagName == 'TEXTAREA') {
				return;
			}
			var text = e.originalEvent.clipboardData.getData('text/plain');
			if (text != null && text.length > 0) {
				e.preventDefault();
				e.stopPropagation();
				var blob = new Blob([text]);
				var url = window.URL.createObjectURL(blob);
				morpheus.HeatMap.showTool(new morpheus.OpenFileTool({
					file: url
				}), controller);
			}
		});
	$keyelement.on('mousewheel', function (e) {
		var scrolly = e.deltaY * e.deltaFactor;
		var scrollx = e.deltaX * e.deltaFactor;
		if (e.altKey) {
			controller.zoom(scrolly > 0, {
				rows: true,
				columns: true
			});
		} else {
			if (scrolly !== 0) {
				controller.scrollTop(controller.scrollTop() - scrolly);
			}
			if (scrollx !== 0) {
				controller.scrollLeft(controller.scrollLeft() + scrollx);
			}
		}
		e.preventDefault();
		e.stopPropagation();
	});
	function shortcutToString(sc) {
		var s = ['<b>'];

		if (i > 0) {
			s.push(', ');
		}
		if (sc.commandKey) {
			s.push(morpheus.Util.COMMAND_KEY);
		}
		if (sc.shiftKey) {
			s.push('Shift+');
		}
		s.push(morpheus.KeyboardCharMap[sc.which[0]]);

		s.push('</b>');
		return s.join('');
	}

	this.showKeyMapReference = function () {
		var html = [];
		html.push('<table class="table table-condensed">');
		shortcutsWhenNotInInputField.concat(shortcuts).forEach(function (sc) {
			html.push('<tr><td>');
			html.push(shortcutToString(sc));
			html.push('</td><td>');
			html.push(sc.name);
			html.push('</td></tr>');
		});

		html.push('</table>');
		morpheus.FormBuilder.showInModal({
			title: 'Keymap Reference',
			html: html.join('')
		});
	};
};
